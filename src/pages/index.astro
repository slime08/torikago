---
import Layout from '../layouts/Layout.astro';
---

<Layout
  title="Home"
  description="トリカゴ公式サイト。みどぺんと一緒に、作る・試す・公開する。YouTubeやXで活動中。"
>
  <div class="page-container" id="pageContainer">
    <!-- 歩くみどぺん（共通） -->
    <div class="walking-midopen" id="walkingMidopen">
      <video muted playsinline id="walkVideo">
        <source src="/midopen-walk.webm" type="video/webm" />
      </video>
    </div>

    <!-- ページ1: ヒーロー -->
    <section class="page-section is-current" data-page="0">
      <div class="page-content">
        <div class="hero">
          <div class="hero-image">
            <img src="/midopen-front.png" alt="みどぺん" />
          </div>
          <h1 class="hero-title">トリカゴ公式サイト</h1>
          <p class="hero-description">
            みどぺんと一緒に、作る・試す・公開する。
          </p>
        </div>
      </div>
      <div class="scroll-hint">↓ スクロールで次へ</div>
    </section>

    <!-- ページ2: 新着情報 -->
    <section class="page-section" data-page="1">
      <div class="page-content">
        <h2 class="section-title">新着情報</h2>
        <div class="card">
          <p class="card-description">
            公式サイトを公開しました。活動情報やガイドラインなどをこちらで発信していきます。
          </p>
        </div>
      </div>
    </section>

    <!-- ページ3: コンテンツ -->
    <section class="page-section" data-page="2">
      <div class="page-content">
        <h2 class="section-title">コンテンツ</h2>
        <div class="card-grid">
          <a href="/about" class="card">
            <h3 class="card-title">About</h3>
            <p class="card-description">トリカゴについて紹介します。</p>
          </a>
          <a href="/character" class="card">
            <h3 class="card-title">Character</h3>
            <p class="card-description">みどぺんの紹介とガイドライン。</p>
          </a>
          <a href="/works" class="card">
            <h3 class="card-title">Works</h3>
            <p class="card-description">制作物の一覧を見る。</p>
          </a>
          <a href="/guidelines" class="card">
            <h3 class="card-title">Guidelines</h3>
            <p class="card-description">素材利用の方針。</p>
          </a>
        </div>
      </div>
    </section>

    <!-- ページ4: リンク -->
    <section class="page-section" data-page="3">
      <div class="page-content">
        <h2 class="section-title">リンク</h2>
        <div class="contact-links">
          <a href="https://www.youtube.com/@%E3%83%88%E3%83%AA%E3%82%AB%E3%82%B4-oAo" class="btn" target="_blank" rel="noopener noreferrer">
            YouTube
          </a>
          <a href="https://x.com/TorikagoNoAka" class="btn btn-outline" target="_blank" rel="noopener noreferrer">
            X (Twitter)
          </a>
        </div>
      </div>
      <div class="scroll-hint scroll-hint-up">↑ スクロールで戻る</div>
    </section>

    <!-- ページインジケーター -->
    <div class="page-indicator">
      <span class="dot is-active" data-goto="0"></span>
      <span class="dot" data-goto="1"></span>
      <span class="dot" data-goto="2"></span>
      <span class="dot" data-goto="3"></span>
    </div>
  </div>
</Layout>

<style>
  .page-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    overflow: hidden;
    background: var(--color-bg);
  }

  .page-section {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: var(--spacing-lg);
    background: var(--color-bg);
    clip-path: inset(0 100% 0 0);
    visibility: hidden;
  }

  .page-section.is-current {
    clip-path: inset(0 0 0 0);
    visibility: visible;
    z-index: 1;
  }

  .page-section.is-next {
    visibility: visible;
    z-index: 2;
  }

  .page-section.is-prev {
    clip-path: inset(0 0 0 0);
    visibility: visible;
    z-index: 1;
  }

  .page-content {
    max-width: var(--max-width);
    width: 100%;
    text-align: center;
  }

  /* 歩くみどぺん */
  .walking-midopen {
    position: fixed;
    bottom: 50px;
    height: 150px;
    z-index: 100;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .walking-midopen.is-visible {
    opacity: 1;
  }

  .walking-midopen video {
    height: 150px;
    width: auto;
  }

  /* ヒーロー */
  .hero {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-md);
  }

  .hero-image {
    width: 280px;
    height: 280px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .hero-image img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    filter: drop-shadow(0 8px 24px rgba(45, 106, 79, 0.2));
  }

  .hero-title {
    font-size: 2.5rem;
    color: var(--color-primary-dark);
  }

  .hero-description {
    font-size: 1.25rem;
    color: var(--color-text-muted);
  }

  /* スクロールヒント */
  .scroll-hint {
    position: absolute;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    color: var(--color-text-muted);
    font-size: 0.875rem;
    animation: bounce 2s infinite;
  }

  .scroll-hint-up {
    animation: bounceUp 2s infinite;
  }

  @keyframes bounce {
    0%, 100% { transform: translateX(-50%) translateY(0); }
    50% { transform: translateX(-50%) translateY(8px); }
  }

  @keyframes bounceUp {
    0%, 100% { transform: translateX(-50%) translateY(0); }
    50% { transform: translateX(-50%) translateY(-8px); }
  }

  /* ページインジケーター */
  .page-indicator {
    position: fixed;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    gap: 12px;
    z-index: 150;
  }

  .dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--color-border);
    cursor: pointer;
    transition: background 0.3s, transform 0.3s;
  }

  .dot:hover {
    transform: scale(1.2);
  }

  .dot.is-active {
    background: var(--color-primary);
  }

  /* カード類 */
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    text-align: left;
  }

  .contact-links {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
    flex-wrap: wrap;
  }

  @media (max-width: 768px) {
    .hero-image {
      width: 200px;
      height: 200px;
    }

    .hero-title {
      font-size: 1.75rem;
    }

    .hero-description {
      font-size: 1rem;
    }

    .walking-midopen {
      height: 100px;
      bottom: 30px;
    }

    .walking-midopen video {
      height: 100px;
    }

    .page-indicator {
      right: 10px;
    }

    .dot {
      width: 10px;
      height: 10px;
    }
  }
</style>

<script is:inline>
  document.addEventListener('DOMContentLoaded', function() {
    var container = document.getElementById('pageContainer');
    var sections = document.querySelectorAll('.page-section');
    var dots = document.querySelectorAll('.dot');
    var walker = document.getElementById('walkingMidopen');
    var video = document.getElementById('walkVideo');

    var currentPage = 0;
    var totalPages = sections.length;
    var isAnimating = false;
    var scrollAccumulator = 0;
    var scrollThreshold = 100;
    var animationDuration = 4000;

    function easeInOutCubic(t) {
      return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
    }

    function goToPage(targetPage, direction) {
      if (isAnimating || targetPage === currentPage || targetPage < 0 || targetPage >= totalPages) {
        return;
      }

      isAnimating = true;
      var currentSection = sections[currentPage];
      var targetSection = sections[targetPage];
      var startTime = null;
      var walkerWidth = 200;
      var screenWidth = window.innerWidth;

      // 次のセクションを準備
      if (direction === 'next') {
        targetSection.classList.add('is-next');
        targetSection.style.clipPath = 'inset(0 100% 0 0)';
      } else {
        targetSection.classList.add('is-prev');
        currentSection.style.zIndex = '2';
        targetSection.style.zIndex = '1';
      }

      // みどぺんを表示
      walker.classList.add('is-visible');
      walker.style.transform = direction === 'next' ? 'scaleX(1)' : 'scaleX(-1)';
      video.currentTime = 0;
      video.play();

      function animate(timestamp) {
        if (!startTime) startTime = timestamp;
        var elapsed = timestamp - startTime;
        var progress = Math.min(elapsed / animationDuration, 1);
        var easedProgress = easeInOutCubic(progress);

        // みどぺんの位置を計算
        var walkerX;
        if (direction === 'next') {
          walkerX = -walkerWidth + (screenWidth + walkerWidth * 2) * easedProgress;
        } else {
          walkerX = screenWidth - (screenWidth + walkerWidth * 2) * easedProgress;
        }
        walker.style.left = walkerX + 'px';

        // ワイプ位置を計算（みどぺんの中心に合わせる）
        var wipePosition = walkerX + walkerWidth / 2;
        var wipePercent = Math.max(0, Math.min(100, (wipePosition / screenWidth) * 100));

        // クリップパスを更新
        if (direction === 'next') {
          // 次のセクションが左から右に広がる
          targetSection.style.clipPath = 'inset(0 ' + (100 - wipePercent) + '% 0 0)';
        } else {
          // 現在のセクションが右から左に消える
          currentSection.style.clipPath = 'inset(0 0 0 ' + (100 - wipePercent) + '%)';
        }

        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          // アニメーション完了
          currentSection.classList.remove('is-current', 'is-prev');
          currentSection.style.clipPath = '';
          currentSection.style.zIndex = '';

          targetSection.classList.remove('is-next');
          targetSection.classList.add('is-current');
          targetSection.style.clipPath = 'inset(0 0 0 0)';
          targetSection.style.zIndex = '';

          walker.classList.remove('is-visible');

          dots[currentPage].classList.remove('is-active');
          dots[targetPage].classList.add('is-active');

          currentPage = targetPage;
          isAnimating = false;
          scrollAccumulator = 0;
        }
      }

      requestAnimationFrame(animate);
    }

    // ホイールイベント
    container.addEventListener('wheel', function(e) {
      e.preventDefault();
      if (isAnimating) return;

      scrollAccumulator += e.deltaY;

      if (scrollAccumulator > scrollThreshold) {
        goToPage(currentPage + 1, 'next');
      } else if (scrollAccumulator < -scrollThreshold) {
        goToPage(currentPage - 1, 'prev');
      }
    }, { passive: false });

    // タッチイベント
    var touchStartY = 0;
    container.addEventListener('touchstart', function(e) {
      touchStartY = e.touches[0].clientY;
    }, { passive: true });

    container.addEventListener('touchend', function(e) {
      if (isAnimating) return;

      var touchEndY = e.changedTouches[0].clientY;
      var diff = touchStartY - touchEndY;

      if (diff > 50) {
        goToPage(currentPage + 1, 'next');
      } else if (diff < -50) {
        goToPage(currentPage - 1, 'prev');
      }
    }, { passive: true });

    // ドットクリック
    dots.forEach(function(dot) {
      dot.addEventListener('click', function() {
        var target = parseInt(this.getAttribute('data-goto'));
        var direction = target > currentPage ? 'next' : 'prev';
        goToPage(target, direction);
      });
    });

    // キーボード操作
    document.addEventListener('keydown', function(e) {
      if (isAnimating) return;

      if (e.key === 'ArrowDown' || e.key === 'PageDown') {
        e.preventDefault();
        goToPage(currentPage + 1, 'next');
      } else if (e.key === 'ArrowUp' || e.key === 'PageUp') {
        e.preventDefault();
        goToPage(currentPage - 1, 'prev');
      }
    });
  });
</script>
